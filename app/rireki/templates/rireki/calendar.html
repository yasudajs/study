{% extends "base.html" %}

{% block title %}å­¦ç¿’å±¥æ­´{% endblock %}

{% block description %}å­¦ç¿’ã—ãŸæ—¥ã®å±¥æ­´ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã—ã¾ã™{% endblock %}

{% block content %}
<div class="calendar-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="calendar-header">
        <div class="calendar-nav">
            <button onclick="previousMonth()">â†å‰æœˆ</button>
        </div>
        <h2 id="calendar-title">2025å¹´12æœˆ</h2>
        <div class="calendar-nav">
            <button onclick="nextMonth()">ç¿Œæœˆâ†’</button>
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
    <div class="calendar-grid" id="calendar-grid">
        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
    </div>

    <!-- è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="detail-container" id="detail-container">
        <div class="no-record">
            æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å­¦ç¿’å±¥æ­´ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„
        </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— -->
    <div class="button-group">
        <button class="btn btn-secondary" onclick="goBackToPortal()">
            ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹
        </button>
        <button class="btn btn-danger" onclick="clearAllHistory()">
            ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤
        </button>
    </div>
</div>

<style>
    .calendar-container {
        max-width: 500px;
        margin: 2rem auto;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .calendar-header h2 {
        margin: 0;
        font-size: 1.3rem;
        color: #333;
    }

    .calendar-nav button {
        padding: 0.5rem 1rem;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .calendar-nav button:hover {
        background: #0056b3;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .day-header {
        text-align: center;
        font-weight: bold;
        color: #666;
        padding: 0.5rem 0;
        font-size: 0.9rem;
    }

    .day-header.sunday { color: #d9534f; }
    .day-header.saturday { color: #5cb85c; }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        position: relative;
        background: #f9f9f9;
    }

    .calendar-day:hover {
        border-color: #007bff;
        background: #e7f3ff;
        transform: scale(1.05);
    }

    .calendar-day.empty {
        background: #f5f5f5;
        cursor: default;
        border: none;
    }

    .calendar-day.empty:hover {
        transform: none;
        background: #f5f5f5;
        border: none;
    }

    .calendar-day.has-record {
        border-color: #28a745;
        background: #d4edda;
        color: #155724;
    }

    .calendar-day.has-record:hover {
        border-color: #155724;
        background: #c3e6cb;
    }

    .calendar-day.today {
        border-color: #007bff;
        background: #cce5ff;
        color: #004085;
        font-weight: bold;
    }

    .calendar-day.today::after {
        content: 'â˜…';
        position: absolute;
        top: -8px;
        right: -8px;
        font-size: 1.2rem;
        color: #ffc107;
    }

    .calendar-day.selected {
        border-color: #ff6b6b;
        background: #ffe0e0;
        box-shadow: 0 0 8px rgba(255, 107, 107, 0.5);
    }

    /* è©³ç´°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .detail-container {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .detail-header {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 1rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }

    .detail-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .app-records {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .app-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .record-item {
        padding: 0.75rem;
        margin: 0.5rem 0;
        background: #f9f9f9;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #666;
    }

    .record-item strong {
        color: #007bff;
    }

    .no-record {
        text-align: center;
        color: #999;
        padding: 2rem 1rem;
    }

    .rate-good { color: #28a745; font-weight: bold; }
    .rate-fair { color: #ffc107; font-weight: bold; }
    .rate-poor { color: #dc3545; font-weight: bold; }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    @media (max-width: 600px) {
        .calendar-container {
            margin: 1rem;
            padding: 1rem;
        }

        .calendar-header {
            flex-direction: column;
            gap: 1rem;
        }

        .button-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>

<script src="{{ url_for('static', filename='js/historyManager.js') }}"></script>
<script>
    let currentDate = new Date();
    let selectedDate = null;

    document.addEventListener('DOMContentLoaded', function() {
        renderCalendar();
        selectToday();
    });

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        document.getElementById('calendar-title').textContent = 
            `${year}å¹´${month + 1}æœˆ`;

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
        const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = `day-header ${day === 'æ—¥' ? 'sunday' : day === 'åœŸ' ? 'saturday' : ''}`;
            header.textContent = day;
            grid.appendChild(header);
        });

        // åˆæ—¥ã®æ›œæ—¥
        const firstDay = new Date(year, month, 1).getDay();

        // ç©ºã‚»ãƒ«
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day empty';
            grid.appendChild(empty);
        }

        // æ—¥ä»˜ã‚»ãƒ«
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        const isCurrentMonth = 
            today.getFullYear() === year && 
            today.getMonth() === month;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const history = historyManager.getHistory();
            const hasRecord = Object.values(history).some(app => 
                app.some(record => record.date === dateStr)
            );

            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (hasRecord) {
                dayCell.classList.add('has-record');
            }
            if (isCurrentMonth && day === today.getDate()) {
                dayCell.classList.add('today');
            }

            dayCell.textContent = day;
            dayCell.onclick = () => selectDate(dateStr, dayCell);
            grid.appendChild(dayCell);
        }
    }

    function selectDate(dateStr, element) {
        // å‰ã®é¸æŠã‚’è§£é™¤
        document.querySelectorAll('.calendar-day.selected').forEach(el => {
            el.classList.remove('selected');
        });

        // æ–°ã—ã„é¸æŠ
        selectedDate = dateStr;
        element.classList.add('selected');

        // è©³ç´°è¡¨ç¤ºã‚’æ›´æ–°
        displayDetails(dateStr);
    }

    function selectToday() {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        const todayCell = Array.from(document.querySelectorAll('.calendar-day')).find(el => 
            el.textContent === String(today.getDate()) && el.classList.contains('today')
        );
        if (todayCell) {
            selectDate(dateStr, todayCell);
        }
    }

    function displayDetails(dateStr) {
        const history = historyManager.getHistory();
        const detailContainer = document.getElementById('detail-container');

        // ãã®æ—¥ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æŠ½å‡º
        const recordsByApp = {};
        Object.entries(history).forEach(([appId, records]) => {
            const dayRecords = records.filter(r => r.date === dateStr);
            if (dayRecords.length > 0) {
                recordsByApp[appId] = dayRecords;
            }
        });

        if (Object.keys(recordsByApp).length === 0) {
            detailContainer.innerHTML = `
                <div class="no-record">
                    <p>${dateStr}ã®å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }

        let html = `<div class="detail-header">${dateStr}ã®å­¦ç¿’å±¥æ­´</div>`;
        html += '<div class="detail-content">';

        // ä¹ä¹
        if (recordsByApp.kuku) {
            html += '<div class="app-records">';
            html += '<div class="app-title">ğŸ“š ä¹ä¹ç·´ç¿’</div>';
            recordsByApp.kuku.forEach(record => {
                const rateClass = record.correctRate >= 90 ? 'rate-good' : 
                                 record.correctRate >= 70 ? 'rate-fair' : 'rate-poor';
                html += `
                    <div class="record-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${record.level}ã®æ®µï¼ˆ${record.mode === 'random' ? 'ãƒ©ãƒ³ãƒ€ãƒ ' : 'ã˜ã‚…ã‚“ã°ã‚“'}ï¼‰</span>
                            <span style="font-size: 0.85rem; color: #999;">${record.time}</span>
                        </div>
                        <div>æ­£ç­”ç‡: <span class="${rateClass}">${record.correctRate}%</span></div>
                        <div class="text-muted" style="font-size: 0.8rem; color: #999;">
                            æ­£è§£: ${record.correctCount}/${record.totalCount}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }

        // å››å‰‡æ¼”ç®—
        if (recordsByApp.shisoku) {
            html += '<div class="app-records">';
            html += '<div class="app-title">ğŸ§® å››å‰‡æ¼”ç®—</div>';
            recordsByApp.shisoku.forEach(record => {
                const operatorName = {
                    'plus': 'ãŸã—ç®—',
                    'minus': 'ã²ãç®—',
                    'multiply': 'ã‹ã‘ç®—',
                    'divide': 'ã‚ã‚Šç®—'
                }[record.operator] || record.operator;

                const difficultyName = record.difficulty === 'easy' ? 'ã‹ã‚“ãŸã‚“' : 'ã‚€ãšã‹ã—ã„';
                const rateClass = record.correctRate >= 90 ? 'rate-good' : 
                                 record.correctRate >= 70 ? 'rate-fair' : 'rate-poor';

                html += `
                    <div class="record-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${operatorName}ï¼ˆ${difficultyName}ï¼‰</span>
                            <span style="font-size: 0.85rem; color: #999;">${record.time}</span>
                        </div>
                        <div>æ­£ç­”ç‡: <span class="${rateClass}">${record.correctRate}%</span></div>
                        <div class="text-muted" style="font-size: 0.8rem; color: #999;">
                            æ­£è§£: ${record.correctCount}/${record.totalCount}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }

        html += '</div>';
        detailContainer.innerHTML = html;
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    function goBackToPortal() {
        window.location.href = '/';
    }

    function clearAllHistory() {
        if (confirm('ã™ã¹ã¦ã®å­¦ç¿’å±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
            if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                historyManager.clearHistory();
                renderCalendar();
                displayDetails(selectedDate || historyManager.getTodayDate());
            }
        }
    }
</script>
{% endblock %}
