# 機能仕様書

## 1. 概要

本セクションでは、アプリケーションの各機能要件を詳細に仕様化します。

### 1.1 設計原則：クライアント側の処理最大化
**想定利用シーン**: 小学生30名が同一学級で同時利用（授業環境）

このため、以下の原則でサーバー負荷を最小化：
- **問題生成**: クライアント側で実施（JavaScriptで全問題を一括生成）
- **採点**: クライアント側で実施（サーバーは検証のみ）
- **セッション管理**: クライアント側で管理（ローカルストレージ + IndexedDB検討）
- **API通信の最小化**: 初回セッション作成と最終結果保存のみサーバー呼び出し

#### サーバー負荷削減効果
| 処理 | 従来（サーバー処理） | 改善後（クライアント処理） | 削減率 |
|-----|-----------------|---------------------|--------|
| 問題生成 | 30回のAPI呼び出し | 1回（セッション生成時）| 96% |
| 採点 | 30名 × 9問 = 270回 | 0回（クライアント処理）| 100% |
| 結果計算 | 30回のAPI呼び出し | 0回（クライアント処理）| 100% |
| **合計API削減** | 300+API呼び出し | 1API呼び出し | **99.7%削減** |

---

## 2. 段選択機能

### 2.1 機能説明
ユーザーが学習対象となる段（1～9）を選択する機能。複数段の同時選択が可能。
**全処理がクライアント側で実行される**

### 2.2 入力
- ユーザーが複数のチェックボックスを選択

### 2.3 処理
| # | ステップ | 実施場所 | 説明 |
|----|---------|--------|------|
| 1 | 段の検証 | **クライアント（JavaScript）** | 最低1つ以上の段が選択されているか確認 |
| 2 | 選択段情報の保存 | **クライアント（メモリ）** | 選択された段情報をメモリに保存 |
| 3 | 選択段の整列 | **クライアント（JavaScript）** | 選択された段を昇順で整列（例：[5, 2, 8] → [2, 5, 8]） |

### 2.4 出力
- 選択された段の配列（例：`[2, 3, 5]`）
- エラーメッセージ（未選択の場合）

### 2.5 エラーハンドリング
| エラー | メッセージ | 動作 |
|--------|-----------|------|
| 段が未選択 | 「1つ以上の段を選択してください」 | OKボタンを無効化 |
---

## 3. 出題方式選択機能

### 3.1 機能説明
出題の順序を選択する機能。
**全処理がクライアント側で実行される**

### 3.2 選択肢

#### 3.2.1 順番出題（Sequential Mode）
- **説明**: 選択した段の問題を昇順に出題
- **例**: 2段を選択した場合 → 2×1, 2×2, 2×3, ... , 2×9 の順
- **複数段の場合**: 段ごとに昇順（例：2段と5段選択 → 2×1, 2×2, ... , 2×9, 5×1, 5×2, ... , 5×9）
- **実装場所**: **クライアント（JavaScript）**

#### 3.2.2 ランダム出題（Random Mode）
- **説明**: 選択した段の問題をランダムな順序で出題
- **例**: 2段を選択した場合 → 2×3, 2×8, 2×1, ... （順不同）
- **実装**: Fisher-Yatesシャッフル（クライアント側）
- **実装場所**: **クライアント（JavaScript）**

### 3.3 出力
- 出題方式（"sequential" または "random"）
- シャッフル後の問題配列（ランダム出題の場合）

---

## 4. 出題機能

### 4.1 機能説明
選択した段と出題方式に従い、九九問題を1問ずつ出題する。
**全問題生成・出題管理がクライアント側で実行される**

### 4.2 問題生成ロジック（クライアント側）

#### 4.2.1 問題の構造
```javascript
{
  id: 問題ID（ユニーク）,
  multiplicand: 掛けられる数（1～9）,
  multiplier: 掛ける数（1～9）,
  correct_answer: 正答,
  user_answer: ユーザーの回答（初期値: null）,
  is_correct: 正誤判定（初期値: null）
}
```

#### 4.2.2 問題リスト生成（JavaScriptで実装）

**実施場所**: クライアント側（JavaScript）
**処理**: セッション開始時に、選択された段から全問題を一括生成

```javascript
function generateQuizzes(selectedLevels, mode) {
  let quizzes = [];
  let quizId = 1;
  
  // 選択された段ごとに問題生成
  selectedLevels.forEach(level => {
    for (let multiplier = 1; multiplier <= 9; multiplier++) {
      quizzes.push({
        id: quizId++,
        multiplicand: level,
        multiplier: multiplier,
        correct_answer: level * multiplier,
        user_answer: null,
        is_correct: null
      });
    }
  });
  
  // モードに応じてシャッフル
  if (mode === 'random') {
    quizzes = shuffleArray(quizzes); // Fisher-Yates
  }
  
  return quizzes;
}
```

**例**:
```
段 [2, 3] を選択、順番出題 の場合:
[
  { id: 1, multiplicand: 2, multiplier: 1, correct_answer: 2 },
  { id: 2, multiplicand: 2, multiplier: 2, correct_answer: 4 },
  ...
  { id: 9, multiplicand: 2, multiplier: 9, correct_answer: 18 },
  { id: 10, multiplicand: 3, multiplier: 1, correct_answer: 3 },
  ...
]
```

### 4.3 出題の流れ（クライアント側で管理）
| # | ステップ | 実施場所 | 説明 |
|----|---------|--------|------|
| 1 | 現在の問題を取得 | **クライアント（JavaScript）** | 問題リストの現在位置から問題を取得 |
| 2 | 画面に表示 | **クライアント（DOM更新）** | 問題（a × b = ?）を表示 |
| 3 | ユーザー回答を待機 | **クライアント（イベントリスナー）** | 入力欄で回答を入力待機 |
| 4 | 「次へ」クリック | **クライアント（JavaScript）** | 回答を記録 |
| 5 | 正誤判定 | **クライアント（JavaScript）** | ユーザーの回答と正答を比較 |
| 6 | 次問へ遷移 | **クライアント（JavaScript）** | 残り問題があれば次問へ、なければ結果画面へ |

### 4.4 エラーハンドリング
| エラー | メッセージ | 動作 | 実施場所 |
|--------|-----------|------|--------|
| 空入力 | 「答えを入力してください」 | 次へボタン無効化 | **クライアント** |
| 非数値入力 | 「数字を入力してください」 | 入力を制限（数字のみ許可） | **クライアント** |

---

## 5. 採点・正誤判定機能

### 5.1 機能説明
ユーザーの回答を正答と比較し、正誤を判定する。
**全採点処理がクライアント側で実行される**

### 5.2 判定ロジック（クライアント側）
```javascript
function scoreQuiz(quiz) {
  return quiz.user_answer === quiz.correct_answer;
}

function scoreAllQuizzes(quizzes) {
  let correctCount = 0;
  
  quizzes.forEach(quiz => {
    if (quiz.user_answer === quiz.correct_answer) {
      quiz.is_correct = true;
      correctCount++;
    } else {
      quiz.is_correct = false;
    }
  });
  
  return correctCount;
}
```

**実施場所**: クライアント側（JavaScript）
**処理タイミング**: ユーザーが「次へ」ボタンをクリック時、またはセッション終了時

### 5.3 フィードバック（クライアント側で表示）
- **正解**: 画面に「○」を表示、次問へ進む
- **不正解**: 画面に「×」と正答を表示、次問へ進む
  - 例：「×（正答は21です）」

### 5.4 正答数のカウント
各問題の判定後、正答数をカウント。

---

## 6. 正答率計算機能

### 6.1 機能説明
全問題に対する正答率をパーセンテージで計算する。
**クライアント側で計算**

### 6.2 計算式（クライアント側）
```javascript
function calculateCorrectRate(quizzes) {
  const totalCount = quizzes.length;
  const correctCount = quizzes.filter(q => q.is_correct).length;
  
  if (totalCount === 0) return 0;
  return Math.round((correctCount / totalCount) * 100);
}
```

**実施場所**: クライアント側（JavaScript）
**処理タイミング**: 全問題終了時

### 6.3 表示形式
- **整数値**: 小数点以下は四捨五入
- **例**:
  - 17問正解 / 20問 = 85%
  - 19問正解 / 20問 = 95%

### 6.4 評価の視覚化（クライアント側で表示）
| 正答率 | 表示色 | コメント | 実施場所 |
|--------|--------|----------|--------|
| 100% | 金色 | 完璧！ | **クライアント** |
| 90%～99% | 青色 | とてもよくできました！ | **クライアント** |
| 80%～89% | 緑色 | よくできました！ | **クライアント** |
| 70%～79% | オレンジ | もう少しです！ | **クライアント** |
| ～69% | 赤色 | もう一度チャレンジ！ | **クライアント** |

---

## 7. 画面遷移機能

### 7.1 画面遷移マップ（全てクライアント側で管理）
```
スタート画面
  ↓[さっそく始める！]
段選択画面
  ↓[OK] ↑[キャンセル（暗黙）]
出題方式選択画面
  ↓[OK] ↑[戻る]
出題画面
  ↓[次へ] ↑[戻る]
正答率表示画面
  ├[最初に戻る] → スタート画面
  └[もう一度] → 出題画面（同じ設定）
```

**実施場所**: 全ての画面遷移がクライアント側（JavaScript）で管理される

### 7.2 遷移時の状態管理（クライアント側）
| 遷移先 | 保持データ | 破棄データ | 管理方法 |
|--------|----------|----------|---------|
| 出題方式選択画面 | 選択段 | なし | **メモリ + ローカルストレージ** |
| 出題画面 | 選択段、出題方式、問題リスト | なし | **メモリ + ローカルストレージ** |
| 正答率表示画面 | 選択段、出題方式、問題リスト、採点結果 | なし | **メモリ + ローカルストレージ** |
| スタート画面へ戻る | なし（リセット） | 全データ | **メモリクリア** |
| 出題画面 | 選択段、出題方式 | なし |
| 正答率表示画面 | 選択段、出題方式、問題リスト、回答履歴 | なし |
| スタート画面 | なし | すべてのデータをリセット |

### 7.3 「戻る」機能の仕様
- **出題画面で戻る**: 「本当に中止しますか？」確認ダイアログを表示
- **段選択画面で戻る**: 確認なしで前画面へ

---

## 8. ローカルデータ保存機能（オプション）

### 8.1 機能説明
現在のセッション中のデータをローカルストレージに保存し、ページリロード時にデータ復帰を試みる。

### 8.2 保存対象
- 選択段
- 出題方式
- 現在の問題番号
- 回答履歴

### 8.3 キー名
```
"kuku_app_state"
```

### 8.4 注意
ユーザーが「最初に戻る」をクリックした時点で、セッションデータをクリアする。

---

## 9. ユーザーインタラクション詳細

### 9.1 チェックボックス動作
- クリックで on/off 切り替え
- リセットボタンで全チェック解除

### 9.2 ラジオボタン動作
- 1つのみ選択可能（デフォルト：順番出題）

### 9.3 テキスト入力フィールド
- 数字のみ入力可能（JavaScript で制限）
- Enter キーで「次へ」と同じ動作（オプション）
- フォーカス時に枠線を強調

### 9.4 ボタン
- ホバー時：視覚的フィードバック（色変化、スケール拡大など）
- クリック時：ダブルクリック対策（連続送信を防止）
- グレーアウト時：クリック不可

---

## 10. 機能テスト項目

| # | テスト項目 | 予想結果 |
|----|-----------|---------|
| 1 | 段の複数選択 | 複数段を選択できる |
| 2 | 空選択でOK | OKボタンが無効化される |
| 3 | 順番出題 | 昇順で出題される |
| 4 | ランダム出題 | ランダム順で出題される |
| 5 | 回答が正しい | ○判定、正答数加算 |
| 6 | 回答が間違う | ×判定、正答数加算なし |
| 7 | 正答率計算 | 正確な計算結果 |
| 8 | 戻る確認 | 確認ダイアログが表示される |
| 9 | もう一度 | 同じ設定で再度出題 |
| 10 | 最初に戻る | スタート画面に戻り、データリセット |
